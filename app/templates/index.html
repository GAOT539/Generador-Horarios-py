{% extends "base.html" %}

{% block content %}
<div id="app">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-primary fw-bold">Calendario (Lunes - Jueves)</h2>
        <button @click="generarHorario" class="btn btn-primary btn-lg shadow" :disabled="loading">
            <span v-if="loading" class="spinner-border spinner-border-sm"></span>
            <span v-else>✨ Generar Horario</span>
        </button>
    </div>

    <div class="card shadow border-0">
        <div class="card-body p-0">
            <div id="calendar"></div>
        </div>
    </div>
</div>

<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>

<script>
    const { createApp } = Vue

    createApp({
        compilerOptions: { delimiters: ['[[', ']]'] },
        data() { return { loading: false, calendar: null } },
        mounted() { this.iniciarCalendario(); },
        methods: {
            iniciarCalendario() {
                var calendarEl = document.getElementById('calendar');
                this.calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'timeGridWeek',
                    locale: 'es',
                    // CAMBIO: Ocultar Domingo(0), Viernes(5) y Sábado(6)
                    hiddenDays: [0, 5, 6], 
                    slotMinTime: '07:00:00',
                    slotMaxTime: '21:00:00',
                    allDaySlot: false,
                    expandRows: true,
                    height: 'auto',
                    dayHeaderFormat: { weekday: 'long' },
                    
                    // CAMBIO: Botones para ver Semana o Día
                    headerToolbar: {
                        left: '',
                        center: '', 
                        right: 'timeGridWeek,timeGridDay'
                    },
                    
                    initialDate: '2023-11-20',
                    events: '/api/horario',
                    eventColor: '#3788d8'
                });
                this.calendar.render();
            },
            async generarHorario() {
                const confirm = await Swal.fire({
                    title: '¿Generar nuevo horario?',
                    text: "Se borrará el horario actual y se creará uno nuevo.",
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Sí, generar'
                });

                if (confirm.isConfirmed) {
                    this.loading = true;
                    try {
                        const res = await fetch('/api/generar', {method: 'POST'});
                        const data = await res.json();
                        if (res.ok) {
                            Swal.fire('¡Éxito!', data.message, 'success');
                            this.calendar.refetchEvents();
                        } else {
                            Swal.fire('Error', data.message, 'error');
                        }
                    } catch (e) {
                        Swal.fire('Error', 'Fallo de conexión', 'error');
                    } finally {
                        this.loading = false;
                    }
                }
            }
        }
    }).mount('#app')
</script>
{% endblock %}