{% extends "base.html" %}

{% block content %}
<div id="app">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-primary fw-bold">Calendario Semanal</h2>
        
        <button @click="generarHorario" class="btn btn-primary btn-lg shadow" :disabled="loading">
            <span v-if="loading" class="spinner-border spinner-border-sm"></span>
            <span v-else>✨ Generar Horario</span>
        </button>
    </div>

    <div class="card shadow border-0">
        <div class="card-body p-0">
            <div id="calendar"></div>
        </div>
    </div>
</div>

<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>

<script>
    const { createApp } = Vue

    createApp({
        compilerOptions: { delimiters: ['[[', ']]'] },
        data() {
            return {
                loading: false,
                calendar: null
            }
        },
        mounted() {
            this.iniciarCalendario();
        },
        methods: {
            iniciarCalendario() {
                var calendarEl = document.getElementById('calendar');
                this.calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'timeGridWeek',
                    locale: 'es',
                    hiddenDays: [0, 6], // Oculta Domingo y Sábado
                    slotMinTime: '07:00:00',
                    slotMaxTime: '21:00:00',
                    allDaySlot: false,
                    expandRows: true, // Estira para llenar altura
                    height: 'auto',
                    
                    // CAMBIO: Formato de encabezado de día (Solo nombre: "Lunes")
                    dayHeaderFormat: { weekday: 'long' },
                    
                    // CAMBIO: Barra de herramientas limpia (sin título de fecha)
                    headerToolbar: {
                        left: '',
                        center: '', 
                        right: ''
                    },
                    
                    initialDate: '2023-11-20', // Fecha base interna para mostrar L-V
                    events: '/api/horario',
                    eventColor: '#3788d8'
                });
                this.calendar.render();
            },
            async generarHorario() {
                const confirm = await Swal.fire({
                    title: '¿Generar nuevo horario?',
                    text: "Se borrará el horario actual y se creará uno nuevo.",
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Sí, generar',
                    cancelButtonText: 'Cancelar'
                });

                if (confirm.isConfirmed) {
                    this.loading = true;
                    try {
                        const res = await fetch('/api/generar', {method: 'POST'});
                        const data = await res.json();
                        
                        if (res.ok) {
                            Swal.fire('¡Éxito!', data.message, 'success');
                            this.calendar.refetchEvents();
                        } else {
                            Swal.fire('Error', data.message, 'error');
                        }
                    } catch (e) {
                        Swal.fire('Error', 'Fallo de conexión', 'error');
                    } finally {
                        this.loading = false;
                    }
                }
            }
        }
    }).mount('#app')
</script>
{% endblock %}