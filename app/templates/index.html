{% extends "base.html" %}

{% block content %}
<div id="app" style="height: calc(100vh - 100px); display: flex; flex-direction: column;">
    
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h2 class="text-primary fw-bold m-0 d-inline-block me-3">üìÖ Calendario Acad√©mico</h2>
            
            <div class="btn-group" role="group">
                <input type="radio" class="btn-check" name="modview" id="viewAll" value="ALL" v-model="vistaModalidad" @change="limpiarFiltrosSecundarios" checked>
                <label class="btn btn-outline-primary" for="viewAll">Todos</label>

                <input type="radio" class="btn-check" name="modview" id="viewReg" value="REGULAR" v-model="vistaModalidad" @change="limpiarFiltrosSecundarios">
                <label class="btn btn-outline-success" for="viewReg">üè´ Presencial</label>

                <input type="radio" class="btn-check" name="modview" id="viewOnl" value="ONLINE" v-model="vistaModalidad" @change="limpiarFiltrosSecundarios">
                <label class="btn btn-outline-purple" for="viewOnl">üíª Online</label>
            </div>
        </div>
        
        <div class="d-flex gap-2">
            <button @click="generarHorario" class="btn btn-primary shadow-sm" :disabled="loading">
                <span v-if="loading" class="spinner-border spinner-border-sm"></span>
                <span v-else>‚ú® Generar Nuevo</span>
            </button>
            
            <button class="btn btn-outline-secondary shadow-sm" @click="toggleSidebar">
                <span v-if="sidebarOpen">Cerrar Filtros ‚ùå</span>
                <span v-else>Filtrar üîç</span>
            </button>
        </div>
    </div>

    <div class="d-flex flex-grow-1 position-relative overflow-hidden shadow border rounded">
        
        <div class="flex-grow-1 p-3 bg-white" style="overflow-y: auto;">
            <div id="calendar"></div>
        </div>

        <div class="sidebar-filtros bg-light border-start p-3" :class="{ 'open': sidebarOpen }">
            <h5 class="mb-3 fw-bold text-secondary">üîç Filtros Din√°micos</h5>
            
            <div class="mb-3">
                <label class="form-label small fw-bold">Materia (General)</label>
                <select v-model="filtros.materiaNombre" class="form-select shadow-sm" @change="filtros.materiaId = ''; aplicarFiltros()">
                    <option value="">-- Todas --</option>
                    <option v-for="nombre in materiasGeneralesDisponibles" :value="nombre">[[ nombre ]]</option>
                </select>
            </div>

            <div class="mb-3">
                <label class="form-label small fw-bold">Nivel / Curso</label>
                <select v-model="filtros.materiaId" class="form-select shadow-sm" @change="aplicarFiltros">
                    <option value="">-- Todos --</option>
                    <option v-for="m in materiasEspecificasDisponibles" :value="m.id">[[ m.nombre ]] - Nivel [[ m.nivel ]]</option>
                </select>
            </div>

            <div class="mb-3">
                <label class="form-label small fw-bold">Profesor</label>
                <select v-model="filtros.profesor" class="form-select shadow-sm" @change="aplicarFiltros">
                    <option value="">-- Todos --</option>
                    <option v-for="p in profesoresDisponibles" :value="p.id">[[ p.nombre ]]</option>
                </select>
            </div>

            <hr>

            <div class="d-grid">
                <button class="btn btn-sm btn-outline-dark" @click="limpiarTodo">
                    Limpiar Filtros üóëÔ∏è
                </button>
            </div>

            <div class="mt-4 alert alert-info small">
                <i class="fas fa-info-circle"></i> 
                Mostrando <strong>[[ eventosVisibles ]]</strong> clases.
            </div>
        </div>

    </div>
</div>

<style>
    .sidebar-filtros {
        width: 300px;
        background-color: #f8f9fa;
        transition: margin-right 0.3s ease-in-out;
        margin-right: -300px;
        min-width: 300px;
    }
    .sidebar-filtros.open {
        margin-right: 0;
    }
    .btn-outline-purple {
        color: #6f42c1;
        border-color: #6f42c1;
    }
    .btn-outline-purple:hover, .btn-check:checked + .btn-outline-purple {
        background-color: #6f42c1;
        color: white;
    }
</style>

<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>

<script>
    const { createApp } = Vue

    createApp({
        compilerOptions: { delimiters: ['[[', ']]'] },
        data() {
            return {
                loading: false,
                sidebarOpen: false, 
                calendar: null,
                
                allEvents: [],      // Todos los eventos crudos
                materias_db: [],    // Info est√°tica de BD
                profesores_db: [],  // Info est√°tica de BD

                // Estado de Filtros
                vistaModalidad: 'ALL',
                filtros: {
                    materiaNombre: '',
                    materiaId: '',
                    profesor: ''
                },
                eventosVisibles: 0
            }
        },
        computed: {
            // 1. Eventos filtrados SOLO por modalidad (Base para los dropdowns)
            eventosBaseModalidad() {
                if (this.vistaModalidad === 'ALL') return this.allEvents;
                return this.allEvents.filter(e => {
                    if (this.vistaModalidad === 'REGULAR') return e.extendedProps.modalidad === 'REGULAR';
                    if (this.vistaModalidad === 'ONLINE') return e.extendedProps.modalidad.includes('ONLINE');
                    return true;
                });
            },

            // 2. Extraer Materias que existen en los eventos actuales
            materiasGeneralesDisponibles() {
                // Obtener IDs de materias presentes en la vista actual
                const idsPresentes = new Set(this.eventosBaseModalidad.map(e => e.extendedProps.materia_id));
                // Filtrar la DB
                const materiasActivas = this.materias_db.filter(m => idsPresentes.has(m.id));
                // Extraer nombres √∫nicos
                return [...new Set(materiasActivas.map(m => m.nombre))].sort();
            },

            // 3. Materias Espec√≠ficas (Filtradas por Nombre General si est√° seleccionado)
            materiasEspecificasDisponibles() {
                const idsPresentes = new Set(this.eventosBaseModalidad.map(e => e.extendedProps.materia_id));
                let filtradas = this.materias_db.filter(m => idsPresentes.has(m.id));
                
                if (this.filtros.materiaNombre) {
                    filtradas = filtradas.filter(m => m.nombre === this.filtros.materiaNombre);
                }
                return filtradas.sort((a,b) => a.nivel - b.nivel);
            },

            // 4. Profesores Disponibles (Filtrados por Materia si est√° seleccionada)
            profesoresDisponibles() {
                // Si hay materia seleccionada, ver qu√© profes dan esa materia en los eventos visibles
                let eventosCandidatos = this.eventosBaseModalidad;
                
                // Si hay filtro de materia nombre
                if (this.filtros.materiaNombre) {
                    // Obtener ids de esa materia
                    const idsMatName = this.materias_db.filter(m => m.nombre === this.filtros.materiaNombre).map(m => m.id);
                    eventosCandidatos = eventosCandidatos.filter(e => idsMatName.includes(e.extendedProps.materia_id));
                }
                // Si hay filtro de materia ID espec√≠fico (gana al nombre)
                if (this.filtros.materiaId) {
                    eventosCandidatos = eventosCandidatos.filter(e => e.extendedProps.materia_id === this.filtros.materiaId);
                }

                const idsProfes = new Set(eventosCandidatos.map(e => e.extendedProps.profesor_id));
                return this.profesores_db.filter(p => idsProfes.has(p.id));
            }
        },
        mounted() {
            this.iniciarCalendario();
            this.cargarDatos();
        },
        methods: {
            toggleSidebar() {
                this.sidebarOpen = !this.sidebarOpen;
                setTimeout(() => { this.calendar.updateSize(); }, 310);
            },
            
            async cargarDatos() {
                try {
                    // Cargar cat√°logos
                    this.materias_db = await (await fetch('/api/materias')).json();
                    this.profesores_db = await (await fetch('/api/profesores')).json();
                    // Cargar eventos
                    const res = await fetch('/api/horario');
                    this.allEvents = await res.json();
                    this.aplicarFiltros();
                } catch (e) { console.error("Error cargando datos", e); }
            },

            limpiarFiltrosSecundarios() {
                this.filtros.materiaNombre = '';
                this.filtros.materiaId = '';
                this.filtros.profesor = '';
                this.aplicarFiltros();
            },

            limpiarTodo() {
                this.vistaModalidad = 'ALL';
                this.limpiarFiltrosSecundarios();
            },

            aplicarFiltros() {
                // Filtro Final que va al Calendario
                const filtrados = this.eventosBaseModalidad.filter(e => {
                    // Materia Nombre
                    if (this.filtros.materiaNombre) {
                        const m = this.materias_db.find(x => x.id === e.extendedProps.materia_id);
                        if (!m || m.nombre !== this.filtros.materiaNombre) return false;
                    }
                    // Materia ID
                    if (this.filtros.materiaId && e.extendedProps.materia_id !== this.filtros.materiaId) return false;
                    // Profesor
                    if (this.filtros.profesor && e.extendedProps.profesor_id !== this.filtros.profesor) return false;

                    return true;
                });

                this.eventosVisibles = filtrados.length;
                if (this.calendar) {
                    this.calendar.removeAllEvents();
                    this.calendar.addEventSource(filtrados);
                }
            },

            iniciarCalendario() {
                var calendarEl = document.getElementById('calendar');
                this.calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'timeGridWeek',
                    locale: 'es',
                    firstDay: 1, // LUNES
                    hiddenDays: [], 
                    slotMinTime: '07:00:00',
                    slotMaxTime: '22:00:00',
                    allDaySlot: false,
                    expandRows: true,
                    height: '100%',
                    dayHeaderFormat: { weekday: 'long' }, // Solo nombre del d√≠a
                    headerToolbar: {
                        left: '',
                        center: '', 
                        right: 'timeGridWeek,timeGridDay'
                    },
                    initialDate: '2023-11-20',
                    eventColor: '#3788d8'
                });
                this.calendar.render();
            },

            async generarHorario() {
                const confirm = await Swal.fire({
                    title: '¬øGenerar nuevo horario?',
                    text: "Se borrar√° el horario actual.",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'S√≠, generar'
                });

                if (confirm.isConfirmed) {
                    this.loading = true;
                    try {
                        await fetch('/api/generar', {method: 'POST'});
                        await this.cargarDatos(); // Recargar todo
                        Swal.fire('¬°√âxito!', 'Horario generado', 'success');
                    } catch (e) {
                        Swal.fire('Error', 'Fallo de conexi√≥n', 'error');
                    } finally {
                        this.loading = false;
                    }
                }
            }
        }
    }).mount('#app')
</script>
{% endblock %}