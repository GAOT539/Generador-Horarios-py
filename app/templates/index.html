{% extends "base.html" %}

{% block content %}
<div id="app" style="height: calc(100vh - 100px); display: flex; flex-direction: column;">
    
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h2 class="text-primary fw-bold m-0 d-inline-block me-3">üìÖ Calendario Acad√©mico</h2>
            
            <div class="btn-group" role="group">
                <input type="radio" class="btn-check" name="modview" id="viewAll" value="ALL" v-model="vistaModalidad" @change="aplicarFiltros" checked>
                <label class="btn btn-outline-primary" for="viewAll">Todos</label>

                <input type="radio" class="btn-check" name="modview" id="viewReg" value="REGULAR" v-model="vistaModalidad" @change="aplicarFiltros">
                <label class="btn btn-outline-success" for="viewReg">üè´ Presencial</label>

                <input type="radio" class="btn-check" name="modview" id="viewOnl" value="ONLINE" v-model="vistaModalidad" @change="aplicarFiltros">
                <label class="btn btn-outline-purple" for="viewOnl">üíª Online</label>
            </div>
        </div>
        
        <div class="d-flex gap-2">
            <button @click="generarHorario" class="btn btn-primary shadow-sm" :disabled="loading">
                <span v-if="loading" class="spinner-border spinner-border-sm"></span>
                <span v-else>‚ú® Generar Nuevo</span>
            </button>
            
            <button class="btn btn-outline-secondary shadow-sm" @click="toggleSidebar">
                <span v-if="sidebarOpen">Cerrar Filtros ‚ùå</span>
                <span v-else>Filtrar üîç</span>
            </button>
        </div>
    </div>

    <div class="d-flex flex-grow-1 position-relative overflow-hidden shadow border rounded">
        
        <div class="flex-grow-1 p-3 bg-white" style="overflow-y: auto;">
            <div id="calendar"></div>
        </div>

        <div class="sidebar-filtros bg-light border-start p-3" :class="{ 'open': sidebarOpen }">
            <h5 class="mb-3 fw-bold text-secondary">üîç Filtros Avanzados</h5>
            
            <div class="mb-3">
                <label class="form-label small fw-bold">Materia (General)</label>
                <select v-model="filtros.materiaNombre" class="form-select shadow-sm" @change="aplicarFiltros">
                    <option value="">-- Todas --</option>
                    <option v-for="nombre in materias_unicas" :value="nombre">[[ nombre ]]</option>
                </select>
            </div>

            <div class="mb-3">
                <label class="form-label small fw-bold">Por Materia (Espec√≠fica)</label>
                <select v-model="filtros.materiaId" class="form-select shadow-sm" @change="aplicarFiltros">
                    <option value="">-- Todas --</option>
                    <option v-for="m in materias_list" :value="m.id">[[ m.nombre ]] (Niv. [[ m.nivel ]])</option>
                </select>
            </div>

            <div class="mb-3">
                <label class="form-label small fw-bold">Por Profesor</label>
                <select v-model="filtros.profesor" class="form-select shadow-sm" @change="aplicarFiltros">
                    <option value="">-- Todos --</option>
                    <option v-for="p in profesores_list" :value="p.id">[[ p.nombre ]]</option>
                </select>
            </div>

            <hr>

            <div class="d-grid">
                <button class="btn btn-sm btn-outline-dark" @click="limpiarFiltros">
                    Limpiar Filtros üóëÔ∏è
                </button>
            </div>

            <div class="mt-4 alert alert-info small">
                <i class="fas fa-info-circle"></i> 
                Mostrando <strong>[[ eventosVisibles ]]</strong> clases.
            </div>
        </div>

    </div>
</div>

<style>
    .sidebar-filtros {
        width: 300px;
        background-color: #f8f9fa;
        transition: margin-right 0.3s ease-in-out;
        margin-right: -300px; /* Oculto por defecto */
        min-width: 300px;
    }
    .sidebar-filtros.open {
        margin-right: 0; /* Visible */
    }
    /* Estilo bot√≥n Online */
    .btn-outline-purple {
        color: #6f42c1;
        border-color: #6f42c1;
    }
    .btn-outline-purple:hover, .btn-check:checked + .btn-outline-purple {
        background-color: #6f42c1;
        color: white;
    }
</style>

<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>

<script>
    const { createApp } = Vue

    createApp({
        compilerOptions: { delimiters: ['[[', ']]'] },
        data() {
            return {
                loading: false,
                sidebarOpen: false, 
                calendar: null,
                
                allEvents: [],
                materias_list: [],
                profesores_list: [],

                // Filtros
                vistaModalidad: 'ALL', // ALL, REGULAR, ONLINE
                filtros: {
                    materiaNombre: '',
                    materiaId: '',
                    profesor: ''
                },
                eventosVisibles: 0
            }
        },
        computed: {
            materias_unicas() {
                const nombres = this.materias_list.map(m => m.nombre);
                return [...new Set(nombres)].sort();
            }
        },
        mounted() {
            this.iniciarCalendario();
            this.cargarDatosFiltros();
        },
        methods: {
            toggleSidebar() {
                this.sidebarOpen = !this.sidebarOpen;
                setTimeout(() => { this.calendar.updateSize(); }, 310);
            },

            async cargarDatosFiltros() {
                try {
                    this.materias_list = await (await fetch('/api/materias')).json();
                    this.profesores_list = await (await fetch('/api/profesores')).json();
                    this.cargarEventos();
                } catch (e) { console.error("Error cargando filtros", e); }
            },

            async cargarEventos() {
                try {
                    const res = await fetch('/api/horario');
                    this.allEvents = await res.json();
                    this.aplicarFiltros();
                } catch (e) { console.error("Error cargando horario", e); }
            },

            aplicarFiltros() {
                const filtrados = this.allEvents.filter(e => {
                    // 1. Filtro de Modalidad (Vista)
                    let passModalidad = true;
                    if (this.vistaModalidad === 'REGULAR') {
                        // Solo si es estrictamente REGULAR
                        passModalidad = (e.extendedProps.modalidad === 'REGULAR');
                    } else if (this.vistaModalidad === 'ONLINE') {
                        // Si contiene ONLINE (ya sea LJ o FDS)
                        passModalidad = e.extendedProps.modalidad.includes('ONLINE');
                    }

                    // 2. Filtro Materia General (Nombre Texto)
                    let passMatName = true;
                    if (this.filtros.materiaNombre) {
                        // Buscamos el nombre en la lista usando el ID del evento
                        const matObj = this.materias_list.find(m => m.id === e.extendedProps.materia_id);
                        if (matObj && matObj.nombre !== this.filtros.materiaNombre) passMatName = false;
                    }

                    // 3. Filtros Espec√≠ficos
                    const passMateria = !this.filtros.materiaId || e.extendedProps.materia_id === this.filtros.materiaId;
                    const passProfe = !this.filtros.profesor || e.extendedProps.profesor_id === this.filtros.profesor;
                    
                    return passModalidad && passMatName && passMateria && passProfe;
                });

                this.eventosVisibles = filtrados.length;

                if (this.calendar) {
                    this.calendar.removeAllEvents();
                    this.calendar.addEventSource(filtrados);
                }
            },

            limpiarFiltros() {
                this.filtros.materiaNombre = '';
                this.filtros.materiaId = '';
                this.filtros.profesor = '';
                this.vistaModalidad = 'ALL';
                this.aplicarFiltros();
            },

            iniciarCalendario() {
                var calendarEl = document.getElementById('calendar');
                this.calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'timeGridWeek',
                    locale: 'es',
                    firstDay: 1, // CAMBIO: Iniciar en Lunes (1) para que el Domingo (d√≠a 6 de la api) sea visible al final
                    hiddenDays: [], 
                    slotMinTime: '07:00:00',
                    slotMaxTime: '22:00:00', 
                    allDaySlot: false,
                    expandRows: true,
                    height: '100%',
                    dayHeaderFormat: { weekday: 'long' }, // CAMBIO: Mostrar solo nombre del d√≠a (Lunes, Martes...)
                    headerToolbar: {
                        left: '',
                        center: '', 
                        right: 'timeGridWeek,timeGridDay'
                    },
                    initialDate: '2023-11-20',
                    eventColor: '#3788d8'
                });
                this.calendar.render();
            },

            async generarHorario() {
                const confirm = await Swal.fire({
                    title: '¬øGenerar nuevo horario?',
                    text: "Se borrar√° el horario actual y se crear√° uno nuevo.",
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'S√≠, generar'
                });

                if (confirm.isConfirmed) {
                    this.loading = true;
                    try {
                        const res = await fetch('/api/generar', {method: 'POST'});
                        const data = await res.json();
                        if (res.ok) {
                            Swal.fire('¬°√âxito!', data.message, 'success');
                            this.cargarEventos();
                        } else {
                            Swal.fire('Error', data.message, 'error');
                        }
                    } catch (e) {
                        Swal.fire('Error', 'Fallo de conexi√≥n', 'error');
                    } finally {
                        this.loading = false;
                    }
                }
            }
        }
    }).mount('#app')
</script>
{% endblock %}