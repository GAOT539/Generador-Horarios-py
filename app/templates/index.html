{% extends "base.html" %}

{% block content %}
<div id="app">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>ðŸ“… Horario General</h2>
        <button @click="generarHorario" class="btn btn-primary btn-lg" :disabled="loading">
            <span v-if="loading" class="spinner-border spinner-border-sm"></span>
            <span v-else>âœ¨ Generar Horario AutomÃ¡tico</span>
        </button>
    </div>

    <div class="card shadow">
        <div class="card-body">
            <div id="calendar"></div>
        </div>
    </div>
</div>

<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>

<script>
    const { createApp } = Vue

    createApp({
        compilerOptions: { delimiters: ['[[', ']]'] },
        data() {
            return {
                loading: false,
                calendar: null
            }
        },
        mounted() {
            this.iniciarCalendario();
        },
        methods: {
            iniciarCalendario() {
                var calendarEl = document.getElementById('calendar');
                this.calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'timeGridWeek',
                    locale: 'es',
                    hiddenDays: [0, 6], // Ocultar Domingo(0) y Sabado(6)
                    slotMinTime: '07:00:00',
                    slotMaxTime: '22:00:00',
                    allDaySlot: false,
                    headerToolbar: {
                        left: '',
                        center: 'title',
                        right: 'timeGridWeek,timeGridDay'
                    },
                    // Fecha base fija para que siempre se vea la misma semana
                    initialDate: '2023-11-20', 
                    events: '/api/horario' // Carga automÃ¡tica desde nuestra API
                });
                this.calendar.render();
            },
            async generarHorario() {
                const confirm = await Swal.fire({
                    title: 'Â¿Generar nuevo horario?',
                    text: "Se borrarÃ¡ el horario anterior y se calcularÃ¡ uno nuevo.",
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'SÃ­, generar'
                });

                if (confirm.isConfirmed) {
                    this.loading = true;
                    try {
                        const res = await fetch('/api/generar', {method: 'POST'});
                        const data = await res.json();
                        
                        if (res.ok) {
                            Swal.fire('Â¡Ã‰xito!', data.message, 'success');
                            this.calendar.refetchEvents(); // Recargar calendario visualmente
                        } else {
                            Swal.fire('Error MatemÃ¡tico', data.message, 'error');
                        }
                    } catch (e) {
                        Swal.fire('Error', 'Fallo de conexiÃ³n con el servidor', 'error');
                    } finally {
                        this.loading = false;
                    }
                }
            }
        }
    }).mount('#app')
</script>
{% endblock %}