{% extends "base.html" %}

{% block content %}
<script src="https://unpkg.com/@popperjs/core@2"></script>
<script src="https://unpkg.com/tippy.js@6"></script>

<style>
    .tippy-box[data-theme~='custom'] {
        background-color: #343a40;
        color: white;
        font-size: 0.85rem;
        border-radius: 6px;
        text-align: left;
    }
    .tooltip-header {
        border-bottom: 1px solid rgba(255,255,255,0.2);
        padding-bottom: 4px;
        margin-bottom: 4px;
        font-weight: bold;
        color: #ffc107;
    }
</style>

<div id="app">
    <h2 class="mb-4">Configuraci√≥n del Sistema</h2>

    <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
        <li class="nav-item">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#materias">üìö 1. Materias</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#profesores">üë®‚Äçüè´ 2. Profesores</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#respaldo">üíæ 3. Respaldo</button>
        </li>
    </ul>

    <div class="tab-content">
        
        <div class="tab-pane fade show active" id="materias">
            <div class="row">
                <div class="col-md-5">
                    <div class="card p-3 shadow-sm border-primary mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5 class="text-primary m-0">Planificar Demanda</h5>
                            <span class="badge bg-secondary">Total Cursos: [[ totalCursosCalculado ]]</span>
                        </div>
                        
                        <form @submit.prevent="crearMateria">
                            <div class="row g-2 mb-3">
                                <div class="col-8">
                                    <label class="small fw-bold">Asignatura</label>
                                    <input type="text" v-model="nuevaMateria.nombre" class="form-control form-control-sm" placeholder="Ej: INGLES" style="text-transform: uppercase;" required>
                                </div>
                                <div class="col-4">
                                    <label class="small fw-bold">Nivel</label>
                                    <select v-model="nuevaMateria.nivel" class="form-select form-select-sm" required>
                                        <option v-for="n in 8" :value="n">[[ n ]]</option>
                                    </select>
                                </div>
                            </div>
                            
                            <p class="small text-muted mb-2 border-bottom pb-1">Ingrese cantidad de cursos por franja horaria:</p>

                            <div class="row g-2" style="font-size: 0.85rem;">
                                <div class="col-md-4">
                                    <div class="p-2 bg-light border rounded h-100">
                                        <h6 class="fw-bold text-center text-dark mb-2" style="font-size: 0.8rem;">üè´ Presencial<br>(Lunes-Jueves)</h6>
                                        <div v-for="h in [7, 9, 11, 13, 15, 17, 19]" :key="'p'+h" class="mb-1 d-flex justify-content-between align-items-center border-bottom pb-1">
                                            <span style="font-size: 0.7rem;">[[ h < 10 ? '0'+h : h ]]:00 - [[ (h+2) < 10 ? '0'+(h+2) : (h+2) ]]:00</span>
                                            <input type="number" v-model.number="nuevaMateria.desglose.PRESENCIAL[h]" class="form-control form-control-sm p-1 text-center" style="width: 40px;" min="0">
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-4">
                                    <div class="p-2 bg-light border rounded h-100">
                                        <h6 class="fw-bold text-center text-success mb-2" style="font-size: 0.8rem;">üíª Virtual<br>(Lunes-Jueves)</h6>
                                        <div v-for="h in [7, 9, 11, 13, 15, 17, 19]" :key="'olj'+h" class="mb-1 d-flex justify-content-between align-items-center border-bottom pb-1">
                                            <span style="font-size: 0.7rem;">[[ h < 10 ? '0'+h : h ]]:00 - [[ (h+2) < 10 ? '0'+(h+2) : (h+2) ]]:00</span>
                                            <input type="number" v-model.number="nuevaMateria.desglose.ONLINE_LJ[h]" class="form-control form-control-sm p-1 text-center border-success" style="width: 40px;" min="0">
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-4">
                                    <div class="p-2 bg-light border rounded h-100">
                                        <h6 class="fw-bold text-center text-primary mb-2" style="font-size: 0.8rem;">üìÖ Virtual<br>(S√°bado)</h6>
                                        <div class="mb-1 d-flex justify-content-between align-items-center border-bottom pb-1">
                                            <span style="font-size: 0.7rem;">08:00 - 17:00</span>
                                            <input type="number" v-model.number="nuevaMateria.desglose.ONLINE_FDS[8]" class="form-control form-control-sm p-1 text-center border-primary" style="width: 40px;" min="0">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <button class="btn btn-primary w-100 mt-3 shadow-sm">Guardar Configuraci√≥n</button>
                        </form>
                    </div>

                    <div class="card shadow-sm border-secondary bg-light mt-3">
                        <div class="card-body p-3">
                            <h6 class="fw-bold text-secondary">‚ÑπÔ∏è Referencia de Niveles</h6>
                            <ul class="list-unstyled small mb-0">
                                <li><strong>Nivel 1:</strong> A1 ‚Äì Principiante</li>
                                <li><strong>Nivel 2:</strong> A2 ‚Äì Elemental</li>
                                <li><strong>Nivel 3:</strong> B1 ‚Äì Pre-intermedio</li>
                                <li><strong>Nivel 4:</strong> B1+ ‚Äì Intermedio</li>
                                <li><strong>Nivel 5:</strong> B2 ‚Äì Intermedio Alto</li>
                                <li><strong>Nivel 6-8:</strong> Avanzados (C1, C1+, C2)</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="col-md-7">
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover align-middle table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th>Materia</th>
                                    <th>Nivel</th>
                                    <th class="text-center">Pres.</th>
                                    <th class="text-center text-success">Virt. LJ</th>
                                    <th class="text-center text-primary">Virt. FDS</th>
                                    <th>Acci√≥n</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="m in materias_list">
                                    <td class="fw-bold">[[ m.nombre ]]</td>
                                    <td><span class="badge bg-secondary">Nivel [[ m.nivel ]]</span></td>
                                    
                                    <td class="text-center fw-bold td-tooltip" 
                                        :data-tippy-content="getTooltip(m.desglose, 'PRESENCIAL')">
                                        [[ m.cantidad_regular ]]
                                    </td>
                                    <td class="text-center text-success fw-bold td-tooltip"
                                        :data-tippy-content="getTooltip(m.desglose, 'ONLINE_LJ')">
                                        [[ m.cantidad_online_lj ]]
                                    </td>
                                    <td class="text-center text-primary fw-bold td-tooltip"
                                        :data-tippy-content="getTooltip(m.desglose, 'ONLINE_FDS')">
                                        [[ m.cantidad_online_fds ]]
                                    </td>
                                    
                                    <td class="text-end"><button @click="borrarMateria(m.id)" class="btn btn-sm btn-danger">üóëÔ∏è</button></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="profesores">
            <div class="row">
                <div class="col-md-4">
                    <div class="card p-3 shadow-sm">
                        <h5>Nuevo Profesor</h5>
                        <form @submit.prevent="guardarProfesor">
                            <label>Nombre Completo</label>
                            <input type="text" v-model="formProfe.nombre" class="form-control mb-2" placeholder="Ej: JUAN PEREZ" style="text-transform: uppercase;" @input="validarNombreProfe" required>
                            
                            <div class="row mb-2">
                                <div class="col-12">
                                    <label>Max Horas Diarias</label>
                                    <input type="number" v-model="formProfe.max_horas_dia" class="form-control" min="2" max="20" required>
                                    <small class="text-muted d-block mt-1">Max Semanal (Auto): <strong>[[ formProfe.max_horas_dia * 4 ]] hrs</strong></small>
                                </div>
                            </div>

                            <label class="fw-bold mt-2">¬øQu√© materias puede dar?</label>
                            <div class="border p-2 mb-3 bg-white" style="max-height: 200px; overflow-y: auto;">
                                <div v-if="materias_list.length === 0" class="text-muted small">Crea materias primero.</div>
                                
                                <div v-for="m in materiasVisibles" :key="m.id" class="form-check">
                                    <input class="form-check-input" type="checkbox" :value="m.id" v-model="formProfe.materias_ids">
                                    <label class="form-check-label">[[ m.nombre ]] (Nivel [[ m.nivel ]])</label>
                                </div>
                                
                                <div v-if="formProfe.materias_ids.length > 0" class="mt-2 small text-primary fst-italic">
                                    * Otras materias ocultas (1 materia m√°x).
                                </div>
                            </div>

                            <button class="btn btn-success w-100">Guardar Profesor</button>
                        </form>
                    </div>
                </div>
                
                <div class="col-md-8">
                    <div style="max-height: 600px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.25rem;">
                        <table class="table table-striped table-hover mb-0">
                            <thead class="table-light" style="position: sticky; top: 0; z-index: 1;">
                                <tr>
                                    <th>Nombre</th>
                                    <th>Max Sem</th>
                                    <th>Max Dia</th>
                                    <th>Competencias</th>
                                    <th>Acci√≥n</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="p in profesores_list">
                                    <td>[[ p.nombre ]]</td>
                                    <td>[[ p.max_horas_semana ]]</td>
                                    <td>[[ p.max_horas_dia ]]</td>
                                    <td><span class="badge bg-info text-dark">[[ p.materias ]]</span></td>
                                    <td>
                                        <button @click="editarNombreProfesor(p)" class="btn btn-sm btn-warning me-2">‚úèÔ∏è</button>
                                        <button @click="borrarProfesor(p.id)" class="btn btn-sm btn-danger">üóëÔ∏è</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="respaldo">
            <div class="row justify-content-center mt-4">
                <div class="col-md-5">
                    <div class="card shadow border-success mb-4">
                        <div class="card-header bg-success text-white"><h5 class="mb-0">üì• Guardar Copia de Seguridad</h5></div>
                        <div class="card-body text-center">
                            <p>Descarga un archivo <strong>.json</strong> con todas las Materias y Profesores configurados.</p>
                            <a href="/api/backup" target="_blank" class="btn btn-outline-success btn-lg w-100">Descargar Respaldo</a>
                        </div>
                    </div>
                </div>
                <div class="col-md-5">
                    <div class="card shadow border-warning">
                        <div class="card-header bg-warning text-dark"><h5 class="mb-0">üì§ Restaurar Datos</h5></div>
                        <div class="card-body">
                            <p class="small text-danger fw-bold">‚ö†Ô∏è ESTO BORRAR√Å LOS DATOS ACTUALES</p>
                            <form @submit.prevent="subirRespaldo">
                                <input type="file" ref="fileInput" class="form-control mb-3" accept=".json" required>
                                <button class="btn btn-warning w-100 fw-bold">Restaurar Base de Datos</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    const { createApp } = Vue

    createApp({
        compilerOptions: { delimiters: ['[[', ']]'] },
        data() {
            return {
                materias_list: [], profesores_list: [],
                nuevaMateria: { 
                    nombre: '', 
                    nivel: 1, 
                    desglose: {
                        PRESENCIAL: {7:0, 9:0, 11:0, 13:0, 15:0, 17:0, 19:0},
                        ONLINE_LJ: {7:0, 9:0, 11:0, 13:0, 15:0, 17:0, 19:0},
                        ONLINE_FDS: {8:0} // Inicio corregido a 8
                    }
                },
                formProfe: { nombre: '', max_horas_dia: 6, materias_ids: [] }
            }
        },
        computed: {
            materiasVisibles() {
                if (this.formProfe.materias_ids.length === 0) {
                    return this.materias_list;
                }
                const primeraId = this.formProfe.materias_ids[0];
                const matSeleccionada = this.materias_list.find(m => m.id === primeraId);
                
                if (!matSeleccionada) return this.materias_list;
                return this.materias_list.filter(m => m.nombre === matSeleccionada.nombre);
            },
            totalCursosCalculado() {
                let total = 0;
                const d = this.nuevaMateria.desglose;
                Object.values(d.PRESENCIAL).forEach(v => total += (parseInt(v)||0));
                Object.values(d.ONLINE_LJ).forEach(v => total += (parseInt(v)||0));
                Object.values(d.ONLINE_FDS).forEach(v => total += (parseInt(v)||0));
                return total;
            }
        },
        mounted() { 
            this.cargarTodo(); 
        },
        updated() {
            this.$nextTick(() => {
                tippy('.td-tooltip', {
                    allowHTML: true,
                    theme: 'custom',
                    placement: 'top'
                });
            });
        },
        methods: {
            getTooltip(desglose, tipo) {
                if (!desglose || !desglose[tipo]) return 'Sin datos';
                let html = '';
                const entries = Object.entries(desglose[tipo]);
                entries.sort((a, b) => parseInt(a[0]) - parseInt(b[0]));
                
                let hasData = false;
                entries.forEach(([hora, cant]) => {
                    if (cant > 0) {
                        hasData = true;
                        const h = parseInt(hora);
                        let rango = "";
                        
                        if (tipo === 'ONLINE_FDS') {
                            rango = "08:00 - 17:00";
                        } else {
                            const hStr = h < 10 ? '0' + h : h;
                            const hEnd = h + 2;
                            const hEndStr = hEnd < 10 ? '0' + hEnd : hEnd;
                            rango = `${hStr}:00 - ${hEndStr}:00`;
                        }
                        html += `<div>${rango} &nbsp; <strong>${cant}</strong></div>`;
                    }
                });
                
                return hasData ? html : 'Sin cursos';
            },

            showSuccess(msg) { Swal.fire({ icon: 'success', title: '¬°Listo!', text: msg, timer: 1500, showConfirmButton: false }); },
            showError(msg) { Swal.fire({ icon: 'error', title: 'Error', text: msg }); },
            async confirmDelete() {
                const res = await Swal.fire({ title: '¬øBorrar?', icon: 'warning', showCancelButton: true, confirmButtonText: 'S√≠', cancelButtonText: 'No' });
                return res.isConfirmed;
            },
            async cargarTodo() {
                try {
                    this.materias_list = await (await fetch('/api/materias')).json();
                    this.profesores_list = await (await fetch('/api/profesores')).json();
                } catch (e) { console.error(e); }
            },
            
            async crearMateria() {
                if(!this.nuevaMateria.nombre) return;
                
                if(this.totalCursosCalculado === 0) {
                    this.showError("Debes agregar al menos 1 curso en alguna franja horaria.");
                    return;
                }

                this.nuevaMateria.nombre = this.nuevaMateria.nombre.toUpperCase();
                
                const res = await fetch('/api/materias', { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify(this.nuevaMateria) 
                });
                
                if (res.ok) { 
                    this.nuevaMateria.nombre = '';
                    this.nuevaMateria.nivel = 1;
                    Object.keys(this.nuevaMateria.desglose).forEach(k => {
                        Object.keys(this.nuevaMateria.desglose[k]).forEach(h => {
                            this.nuevaMateria.desglose[k][h] = 0;
                        });
                    });
                    this.cargarTodo(); 
                    this.showSuccess('Materia guardada con desglose horario'); 
                } else { 
                    const d = await res.json(); this.showError(d.error); 
                }
            },
            
            async borrarMateria(id) { if(await this.confirmDelete()) { await fetch('/api/materias?id='+id, {method:'DELETE'}); this.cargarTodo(); } },
            validarNombreProfe() { this.formProfe.nombre = this.formProfe.nombre.replace(/[^a-zA-Z√±√ë√°√©√≠√≥√∫√Å√â√ç√ì√ö\s]/g, ''); },
            
            async guardarProfesor() {
                const nivelesPorMateria = {};
                const nombresMaterias = new Set();

                this.formProfe.materias_ids.forEach(id => {
                    const mat = this.materias_list.find(m => m.id === id);
                    if (!mat) return;
                    
                    nombresMaterias.add(mat.nombre);
                    if (!nivelesPorMateria[mat.nombre]) nivelesPorMateria[mat.nombre] = new Set();
                    nivelesPorMateria[mat.nombre].add(mat.nivel);
                });

                if (nombresMaterias.size > 1) {
                    this.showError("Error de Sistema: No se permite asignar m√°s de una materia distinta por profesor.");
                    this.formProfe.materias_ids = []; 
                    return;
                }

                for (const [nombreMateria, niveles] of Object.entries(nivelesPorMateria)) {
                    if (niveles.size > 3) {
                        this.showError(`Error: El profesor no puede impartir m√°s de 3 niveles de ${nombreMateria}.`);
                        return;
                    }
                }

                const hDia = this.formProfe.max_horas_dia;
                const hSem = hDia * 4; 

                if (hDia < 2 || hDia > 20) { this.showError("Horas diarias deben ser entre 2 y 20."); return; }
                if(this.formProfe.materias_ids.length===0) { this.showError("Selecciona materias"); return; }
                
                this.formProfe.nombre = this.formProfe.nombre.toUpperCase();
                
                const payload = { ...this.formProfe, max_horas_semana: hSem };

                const res = await fetch('/api/profesores', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
                if(res.ok) { 
                    this.formProfe.nombre=''; this.formProfe.materias_ids=[]; 
                    this.cargarTodo(); this.showSuccess('Profesor OK'); 
                } else { this.showError("Error al guardar"); }
            },

            async editarNombreProfesor(profesor) {
                const { value: nuevoNombre } = await Swal.fire({
                    title: 'Editar Nombre',
                    input: 'text',
                    inputValue: profesor.nombre,
                    showCancelButton: true,
                    inputValidator: (value) => { if (!value) return 'El nombre no puede estar vac√≠o'; }
                });

                if (nuevoNombre) {
                    const nombreMayus = nuevoNombre.toUpperCase();
                    const res = await fetch('/api/profesores/' + profesor.id, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ nombre: nombreMayus })
                    });

                    if (res.ok) { this.cargarTodo(); this.showSuccess('Nombre actualizado'); } 
                    else { this.showError('Error al actualizar'); }
                }
            },

            async borrarProfesor(id) { if(await this.confirmDelete()) { await fetch('/api/profesores/'+id, {method:'DELETE'}); this.cargarTodo(); } },
            
            async subirRespaldo() {
                const file = this.$refs.fileInput.files[0];
                if (!file) return;
                
                const confirm = await Swal.fire({
                    title: '¬øEst√°s seguro?',
                    text: "Se borrar√°n todos los datos actuales y se reemplazar√°n por el archivo.",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    confirmButtonText: 'S√≠, restaurar'
                });
                
                if (confirm.isConfirmed) {
                    const formData = new FormData();
                    formData.append('file', file);

                    try {
                        const res = await fetch('/api/restore', { method: 'POST', body: formData });
                        const data = await res.json();
                        if (res.ok) {
                            Swal.fire('Restaurado', data.message, 'success');
                            this.cargarTodo();
                            this.$refs.fileInput.value = ''; 
                        } else { this.showError(data.error); }
                    } catch (e) { this.showError("Error al subir archivo"); }
                }
            }
        }
    }).mount('#app')
</script>
{% endblock %}