{% extends "base.html" %}

{% block content %}
<div id="app">
    <h2 class="mb-4">Configuraci√≥n del Sistema</h2>

    <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
        <li class="nav-item">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#materias">üìö 1. Materias</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#profesores">üë®‚Äçüè´ 2. Profesores</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#respaldo">üíæ 3. Respaldo</button>
        </li>
    </ul>

    <div class="tab-content">
        
        <div class="tab-pane fade show active" id="materias">
            <div class="row">
                <div class="col-md-4">
                    <div class="card p-3 shadow-sm border-primary mb-3">
                        <h5 class="text-primary">Planificar Demanda</h5>
                        <p class="small text-muted">El sistema crear√° los cursos (A, B, C...) autom√°ticamente seg√∫n la cantidad.</p>
                        <form @submit.prevent="crearMateria">
                            <div class="mb-2">
                                <label>Asignatura</label>
                                <input type="text" v-model="nuevaMateria.nombre" class="form-control" placeholder="Ej: INGLES" style="text-transform: uppercase;" required>
                            </div>
                            <div class="row mb-2">
                                <div class="col-6">
                                    <label>Nivel</label>
                                    <select v-model="nuevaMateria.nivel" class="form-select" required>
                                        <option>1</option><option>2</option><option>3</option><option>4</option>
                                        <option>5</option><option>6</option><option>7</option><option>8</option>
                                    </select>
                                </div>
                                <div class="col-6">
                                    <label>Cursos</label>
                                    <input type="number" v-model="nuevaMateria.cantidad" class="form-control" min="1" required>
                                </div>
                            </div>
                            <button class="btn btn-primary w-100">Guardar</button>
                        </form>
                    </div>

                    <div class="card shadow-sm border-secondary bg-light">
                        <div class="card-body p-3">
                            <h6 class="fw-bold text-secondary">‚ÑπÔ∏è Referencia de Niveles</h6>
                            <ul class="list-unstyled small mb-0">
                                <li><strong>Nivel 1:</strong> A1 ‚Äì Principiante</li>
                                <li><strong>Nivel 2:</strong> A2 ‚Äì Elemental</li>
                                <li><strong>Nivel 3:</strong> B1 ‚Äì Pre-intermedio</li>
                                <li><strong>Nivel 4:</strong> B1+ ‚Äì Intermedio</li>
                                <li><strong>Nivel 5:</strong> B2 ‚Äì Intermedio Alto</li>
                                <li><strong>Nivel 6-8:</strong> Avanzados (C1, C1+, C2)</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="col-md-8">
                    <table class="table table-bordered table-hover">
                        <thead class="table-light"><tr><th>Materia</th><th>Nivel</th><th>Cursos a crear</th><th>Acci√≥n</th></tr></thead>
                        <tbody>
                            <tr v-for="m in materias_list">
                                <td class="fw-bold">[[ m.nombre ]]</td>
                                <td><span class="badge bg-secondary">Nivel [[ m.nivel ]]</span></td>
                                <td><strong>[[ m.cantidad_grupos ]]</strong> <span class="text-muted small">(A, B...)</span></td>
                                <td class="text-end"><button @click="borrarMateria(m.id)" class="btn btn-sm btn-danger">üóëÔ∏è</button></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="profesores">
            <div class="row">
                <div class="col-md-4">
                    <div class="card p-3 shadow-sm">
                        <h5>Nuevo Profesor</h5>
                        <form @submit.prevent="guardarProfesor">
                            <label>Nombre Completo</label>
                            <input type="text" v-model="formProfe.nombre" class="form-control mb-2" placeholder="Ej: JUAN PEREZ" style="text-transform: uppercase;" @input="validarNombreProfe" required>
                            
                            <div class="row mb-2">
                                <div class="col-12">
                                    <label>Max Horas Diarias</label>
                                    <input type="number" v-model="formProfe.max_horas_dia" class="form-control" min="2" max="20" required>
                                    <small class="text-muted d-block mt-1">Max Semanal (Auto): <strong>[[ formProfe.max_horas_dia * 4 ]] hrs</strong></small>
                                </div>
                            </div>

                            <label class="fw-bold mt-2">¬øQu√© materias puede dar?</label>
                            <div class="border p-2 mb-3" style="max-height: 150px; overflow-y: auto;">
                                <div v-if="materias_list.length === 0" class="text-muted small">Crea materias primero.</div>
                                <div v-for="m in materias_list" :key="m.id" class="form-check">
                                    <input class="form-check-input" type="checkbox" :value="m.id" v-model="formProfe.materias_ids">
                                    <label class="form-check-label">[[ m.nombre ]] (Nivel [[ m.nivel ]])</label>
                                </div>
                            </div>

                            <button class="btn btn-success w-100">Guardar Profesor</button>
                        </form>
                    </div>
                </div>
                
                <div class="col-md-8">
                    <table class="table table-striped table-hover">
                        <thead class="table-light"><tr><th>Nombre</th><th>Max Sem</th><th>Max Dia</th><th>Competencias</th><th>Acci√≥n</th></tr></thead>
                        <tbody>
                            <tr v-for="p in profesores_list">
                                <td>[[ p.nombre ]]</td>
                                <td>[[ p.max_horas_semana ]]</td>
                                <td>[[ p.max_horas_dia ]]</td>
                                <td><span class="badge bg-info text-dark">[[ p.materias ]]</span></td>
                                <td>
                                    <button @click="editarNombreProfesor(p)" class="btn btn-sm btn-warning me-2">‚úèÔ∏è</button>
                                    <button @click="borrarProfesor(p.id)" class="btn btn-sm btn-danger">üóëÔ∏è</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="respaldo">
            <div class="row justify-content-center mt-4">
                <div class="col-md-5">
                    <div class="card shadow border-success mb-4">
                        <div class="card-header bg-success text-white"><h5 class="mb-0">üì• Guardar Copia de Seguridad</h5></div>
                        <div class="card-body text-center">
                            <p>Descarga un archivo <strong>.json</strong> con todas las Materias y Profesores configurados.</p>
                            <a href="/api/backup" target="_blank" class="btn btn-outline-success btn-lg w-100">Descargar Respaldo</a>
                        </div>
                    </div>
                </div>
                <div class="col-md-5">
                    <div class="card shadow border-warning">
                        <div class="card-header bg-warning text-dark"><h5 class="mb-0">üì§ Restaurar Datos</h5></div>
                        <div class="card-body">
                            <p class="small text-danger fw-bold">‚ö†Ô∏è ESTO BORRAR√Å LOS DATOS ACTUALES</p>
                            <p>Sube un archivo .json previamente descargado.</p>
                            <form @submit.prevent="subirRespaldo">
                                <input type="file" ref="fileInput" class="form-control mb-3" accept=".json" required>
                                <button class="btn btn-warning w-100 fw-bold">Restaurar Base de Datos</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    const { createApp } = Vue

    createApp({
        compilerOptions: { delimiters: ['[[', ']]'] },
        data() {
            return {
                materias_list: [], profesores_list: [],
                nuevaMateria: { nombre: '', nivel: 1, cantidad: 1 },
                formProfe: { nombre: '', max_horas_dia: 6, materias_ids: [] }
            }
        },
        mounted() { this.cargarTodo(); },
        methods: {
            showSuccess(msg) { Swal.fire({ icon: 'success', title: '¬°Listo!', text: msg, timer: 1500, showConfirmButton: false }); },
            showError(msg) { Swal.fire({ icon: 'error', title: 'Error', text: msg }); },
            async confirmDelete() {
                const res = await Swal.fire({ title: '¬øBorrar?', icon: 'warning', showCancelButton: true, confirmButtonText: 'S√≠', cancelButtonText: 'No' });
                return res.isConfirmed;
            },
            async cargarTodo() {
                try {
                    this.materias_list = await (await fetch('/api/materias')).json();
                    this.profesores_list = await (await fetch('/api/profesores')).json();
                } catch (e) { console.error(e); }
            },
            
            async crearMateria() {
                if(!this.nuevaMateria.nombre) return;
                this.nuevaMateria.nombre = this.nuevaMateria.nombre.toUpperCase();
                const res = await fetch('/api/materias', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(this.nuevaMateria) });
                if (res.ok) { this.nuevaMateria = { nombre: '', nivel: 1, cantidad: 1 }; this.cargarTodo(); this.showSuccess('Materia guardada'); }
                else { const d = await res.json(); this.showError(d.error); }
            },
            async borrarMateria(id) { if(await this.confirmDelete()) { await fetch('/api/materias?id='+id, {method:'DELETE'}); this.cargarTodo(); } },
            validarNombreProfe() { this.formProfe.nombre = this.formProfe.nombre.replace(/[^a-zA-Z√±√ë√°√©√≠√≥√∫√Å√â√ç√ì√ö\s]/g, ''); },
            
            async guardarProfesor() {
                // CAMBIO: Validaci√≥n de m√°ximo 2 niveles por materia
                const nivelesPorMateria = {};
                
                this.formProfe.materias_ids.forEach(id => {
                    const mat = this.materias_list.find(m => m.id === id);
                    if (!mat) return;
                    if (!nivelesPorMateria[mat.nombre]) {
                        nivelesPorMateria[mat.nombre] = new Set();
                    }
                    nivelesPorMateria[mat.nombre].add(mat.nivel);
                });

                // Verificar si alguna materia tiene m√°s de 2 niveles distintos
                for (const [nombreMateria, niveles] of Object.entries(nivelesPorMateria)) {
                    if (niveles.size > 2) {
                        this.showError(`El profesor no puede impartir m√°s de 2 niveles de ${nombreMateria}.`);
                        return;
                    }
                }

                // C√°lculo autom√°tico
                const hDia = this.formProfe.max_horas_dia;
                const hSem = hDia * 4; 

                if (hDia < 2 || hDia > 20) { this.showError("Horas diarias deben ser entre 2 y 20."); return; }
                if(this.formProfe.materias_ids.length===0) { this.showError("Selecciona materias"); return; }
                
                this.formProfe.nombre = this.formProfe.nombre.toUpperCase();
                
                const payload = {
                    ...this.formProfe,
                    max_horas_semana: hSem
                };

                const res = await fetch('/api/profesores', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
                if(res.ok) { 
                    this.formProfe.nombre=''; this.formProfe.materias_ids=[]; 
                    this.cargarTodo(); this.showSuccess('Profesor OK'); 
                }
                else { this.showError("Error al guardar"); }
            },

            // CAMBIO: Funci√≥n para editar nombre
            async editarNombreProfesor(profesor) {
                const { value: nuevoNombre } = await Swal.fire({
                    title: 'Editar Nombre',
                    input: 'text',
                    inputValue: profesor.nombre,
                    showCancelButton: true,
                    inputValidator: (value) => {
                        if (!value) return 'El nombre no puede estar vac√≠o';
                    }
                });

                if (nuevoNombre) {
                    const nombreMayus = nuevoNombre.toUpperCase();
                    const res = await fetch('/api/profesores/' + profesor.id, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ nombre: nombreMayus })
                    });

                    if (res.ok) {
                        await this.cargarTodo();
                        this.showSuccess('Nombre actualizado');
                    } else {
                        this.showError('Error al actualizar');
                    }
                }
            },

            async borrarProfesor(id) { if(await this.confirmDelete()) { await fetch('/api/profesores/'+id, {method:'DELETE'}); this.cargarTodo(); } },
            
            async subirRespaldo() {
                const file = this.$refs.fileInput.files[0];
                if (!file) return;
                
                const confirm = await Swal.fire({
                    title: '¬øEst√°s seguro?',
                    text: "Se borrar√°n todos los datos actuales y se reemplazar√°n por el archivo.",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    confirmButtonText: 'S√≠, restaurar'
                });
                
                if (confirm.isConfirmed) {
                    const formData = new FormData();
                    formData.append('file', file);

                    try {
                        const res = await fetch('/api/restore', { method: 'POST', body: formData });
                        const data = await res.json();
                        if (res.ok) {
                            Swal.fire('Restaurado', data.message, 'success');
                            this.cargarTodo();
                            this.$refs.fileInput.value = '';
                        } else {
                            this.showError(data.error);
                        }
                    } catch (e) {
                        this.showError("Error al subir archivo");
                    }
                }
            }
        }
    }).mount('#app')
</script>
{% endblock %}