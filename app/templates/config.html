{% extends "base.html" %}

{% block content %}
<div id="app">
    <h2 class="mb-4">Configuraci√≥n del Sistema</h2>

    <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
        <li class="nav-item">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#aulas">üè¢ 1. Aulas</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#materias">üìö 2. Materias</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#profesores">üë®‚Äçüè´ 3. Profesores</button>
        </li>
    </ul>

    <div class="tab-content">
        
        <div class="tab-pane fade show active" id="aulas">
            <div class="row">
                <div class="col-md-4">
                    <div class="card p-3 shadow-sm">
                        <h5>Crear Aula</h5>
                        <form @submit.prevent="crearAula">
                            <input v-model="nuevaAula" class="form-control mb-2" placeholder="Nombre (Ej: Aula 101)" required>
                            <button class="btn btn-primary w-100">Agregar</button>
                        </form>
                    </div>
                </div>
                <div class="col-md-8">
                    <table class="table table-bordered table-hover">
                        <thead class="table-light"><tr><th>Aulas Registradas</th><th>Acci√≥n</th></tr></thead>
                        <tbody>
                            <tr v-for="a in aulas">
                                <td>[[ a.nombre ]]</td>
                                <td class="text-end"><button @click="borrarAula(a.id)" class="btn btn-sm btn-danger">üóëÔ∏è</button></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="materias">
            <div class="row">
                <div class="col-md-4">
                    <div class="card p-3 shadow-sm border-primary">
                        <h5 class="text-primary">Planificar Demanda</h5>
                        <p class="small text-muted">El sistema crear√° los cursos (A, B, C...) autom√°ticamente seg√∫n la cantidad que pongas aqu√≠.</p>
                        <form @submit.prevent="crearMateria">
                            <div class="mb-2">
                                <label>Asignatura</label>
                                <input 
                                    type="text" 
                                    v-model="nuevaMateria.nombre" 
                                    class="form-control" 
                                    placeholder="Ej: INGLES" 
                                    style="text-transform: uppercase;"
                                    required
                                >
                            </div>
                            
                            <div class="row mb-2">
                                <div class="col-6">
                                    <label>Nivel</label>
                                    <select v-model="nuevaMateria.nivel" class="form-select" required>
                                        <option>1</option>
                                        <option>2</option>
                                        <option>3</option>
                                        <option>4</option>
                                    </select>
                                </div>
                                <div class="col-6">
                                    <label>Grupos</label>
                                    <input type="number" v-model="nuevaMateria.cantidad" class="form-control" min="1" required>
                                </div>
                            </div>

                            <button class="btn btn-primary w-100">Guardar</button>
                        </form>
                    </div>
                </div>
                <div class="col-md-8">
                    <table class="table table-bordered table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Materia</th>
                                <th>Nivel</th>
                                <th>Grupos a crear</th>
                                <th>Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="m in materias_list">
                                <td class="fw-bold">[[ m.nombre ]]</td>
                                <td><span class="badge bg-secondary">Nivel [[ m.nivel ]]</span></td>
                                <td>
                                    <strong>[[ m.cantidad_grupos ]]</strong> 
                                    <span class="text-muted small">(A, B...)</span>
                                </td>
                                <td class="text-end"><button @click="borrarMateria(m.id)" class="btn btn-sm btn-danger">üóëÔ∏è</button></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="profesores">
            <div class="row">
                <div class="col-md-4">
                    <div class="card p-3 shadow-sm">
                        <h5>Nuevo Profesor</h5>
                        <form @submit.prevent="guardarProfesor">
                            <label>C√©dula</label>
                            <input v-model="formProfe.cedula" class="form-control mb-2" required>
                            
                            <label>Nombre</label>
                            <input v-model="formProfe.nombre" class="form-control mb-2" required>
                            
                            <div class="row">
                                <div class="col-6">
                                    <label>Max Sem</label>
                                    <input type="number" v-model="formProfe.max_horas_semana" class="form-control mb-2">
                                </div>
                                <div class="col-6">
                                    <label>Max D√≠a</label>
                                    <input type="number" v-model="formProfe.max_horas_dia" class="form-control mb-2">
                                </div>
                            </div>

                            <label class="fw-bold mt-2">¬øQu√© materias puede dar?</label>
                            <div class="border p-2 mb-3" style="max-height: 150px; overflow-y: auto;">
                                <div v-if="materias_list.length === 0" class="text-muted small">Crea materias primero.</div>
                                <div v-for="m in materias_list" :key="m.id" class="form-check">
                                    <input class="form-check-input" type="checkbox" :value="m.id" v-model="formProfe.materias_ids">
                                    <label class="form-check-label">[[ m.nombre ]] (Nivel [[ m.nivel ]])</label>
                                </div>
                            </div>

                            <button class="btn btn-success w-100">Guardar Profesor</button>
                        </form>
                    </div>
                </div>
                
                <div class="col-md-8">
                    <table class="table table-striped table-hover">
                        <thead class="table-light"><tr><th>C√©dula</th><th>Nombre</th><th>Competencias</th><th>Acci√≥n</th></tr></thead>
                        <tbody>
                            <tr v-for="p in profesores_list">
                                <td>[[ p.cedula ]]</td>
                                <td>[[ p.nombre ]]</td>
                                <td><span class="badge bg-info text-dark">[[ p.materias ]]</span></td>
                                <td><button @click="borrarProfesor(p.id)" class="btn btn-sm btn-danger">üóëÔ∏è</button></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const { createApp } = Vue

    createApp({
        compilerOptions: { delimiters: ['[[', ']]'] },
        data() {
            return {
                aulas: [],
                materias_list: [],
                profesores_list: [],
                
                nuevaAula: '',
                nuevaMateria: { nombre: '', nivel: 1, cantidad: 1 },
                
                formProfe: {
                    cedula: '', nombre: '', max_horas_semana: 20, max_horas_dia: 6, materias_ids: []
                }
            }
        },
        mounted() {
            this.cargarTodo();
        },
        methods: {
            showSuccess(msg) { Swal.fire({ icon: 'success', title: '¬°Listo!', text: msg, timer: 1500, showConfirmButton: false }); },
            showError(msg) { Swal.fire({ icon: 'error', title: 'Error', text: msg }); },
            async confirmDelete() {
                const res = await Swal.fire({ title: '¬øBorrar?', icon: 'warning', showCancelButton: true, confirmButtonText: 'S√≠', cancelButtonText: 'No' });
                return res.isConfirmed;
            },

            async cargarTodo() {
                try {
                    this.aulas = await (await fetch('/api/aulas')).json();
                    this.materias_list = await (await fetch('/api/materias')).json();
                    this.profesores_list = await (await fetch('/api/profesores')).json();
                } catch (e) { console.error(e); }
            },

            async crearAula() {
                await fetch('/api/aulas', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({nombre: this.nuevaAula}) });
                this.nuevaAula = ''; this.cargarTodo(); this.showSuccess('Aula creada');
            },
            async borrarAula(id) {
                if(await this.confirmDelete()) { await fetch('/api/aulas?id=' + id, {method: 'DELETE'}); this.cargarTodo(); }
            },

            async crearMateria() {
                if(!this.nuevaMateria.nombre) { this.showError("Nombre obligatorio"); return; }
                this.nuevaMateria.nombre = this.nuevaMateria.nombre.toUpperCase();
                const res = await fetch('/api/materias', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(this.nuevaMateria) });
                
                if (res.ok) {
                    this.nuevaMateria = { nombre: '', nivel: 1, cantidad: 1 };
                    this.cargarTodo(); this.showSuccess('Materia guardada');
                } else {
                    const d = await res.json();
                    this.showError(d.error === 'Duplicado o error de datos' ? 'Esta materia ya existe.' : 'Error');
                }
            },
            async borrarMateria(id) {
                if(await this.confirmDelete()) { await fetch('/api/materias?id=' + id, {method: 'DELETE'}); this.cargarTodo(); }
            },

            async guardarProfesor() {
                if(this.formProfe.materias_ids.length === 0) { this.showError("Selecciona materias"); return; }
                const res = await fetch('/api/profesores', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(this.formProfe) });
                if(res.ok) {
                    this.formProfe.cedula = ''; this.formProfe.nombre = ''; this.formProfe.materias_ids = [];
                    this.cargarTodo(); this.showSuccess('Profesor OK');
                } else { this.showError("Error (C√©dula duplicada)"); }
            },
            async borrarProfesor(id) {
                if(await this.confirmDelete()) { await fetch('/api/profesores/' + id, {method: 'DELETE'}); this.cargarTodo(); }
            }
        }
    }).mount('#app')
</script>
{% endblock %}