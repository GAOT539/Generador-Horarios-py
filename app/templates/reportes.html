{% extends "base.html" %}

{% block content %}
<div id="app-reportes">
    <h2 class="text-primary fw-bold mb-4 no-print">üìä Reportes y Estad√≠sticas</h2>

    <div class="print-header text-center mb-2" :class="{ 'd-none': isPrintingIndividual || isPrintingCompletos }">
        <h2 class="fw-bold m-0">HORARIOS ACAD√âMICOS</h2>
        <p class="text-muted small m-0">Centro de Idiomas</p>
        <hr class="my-2">
    </div>

    <ul class="nav nav-tabs mb-4 no-print" id="reportTabs" role="tablist">
        <li class="nav-item">
            <button class="nav-link active" id="general-tab" data-bs-toggle="tab" data-bs-target="#general" type="button">
                üìë Reporte General
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="completos-tab" data-bs-toggle="tab" data-bs-target="#completos" type="button">
                üóìÔ∏è Horarios Completos
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="stats-tab" data-bs-toggle="tab" data-bs-target="#stats" type="button">
                üìà Estad√≠sticas
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="individual-tab" data-bs-toggle="tab" data-bs-target="#individual" type="button">
                üë§ Horario Individual
            </button>
        </li>
    </ul>

    <div class="tab-content" id="reportTabsContent">
        
        <div class="tab-pane fade show active" id="general" role="tabpanel">
            <div class="card shadow-sm border-0">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-center mb-3 no-print">
                        <h5 class="card-title fw-bold">Oferta Acad√©mica</h5>
                        <button class="btn btn-outline-primary btn-sm" @click="imprimirGeneral">üñ®Ô∏è Imprimir Reporte</button>
                    </div>

                    <div v-if="loading" class="text-center py-5 no-print">
                        <div class="spinner-border text-primary" role="status"></div>
                    </div>

                    <div v-else>
                        <div v-for="(gruposModalidad, idioma) in reporteGeneralData" :key="idioma" class="mb-4 section-break">
                            <h3 class="text-uppercase fw-bold text-dark border-bottom border-3 pb-1 mb-3 title-keep" style="border-color: #0d6efd !important;">
                                üìò [[ idioma ]]
                            </h3>

                            <div v-for="(niveles, modalidad) in gruposModalidad" :key="modalidad" class="mb-3 ms-2">
                                <div class="p-1 mb-2 bg-light border-start border-4 border-primary modal-header-print">
                                    <h6 class="fw-bold text-primary m-0 text-uppercase">
                                        MODALIDAD [[ modalidad ]]
                                    </h6>
                                </div>

                                <div v-for="(horarios, nivelNum) in niveles" :key="nivelNum" class="mb-3 ms-3">
                                    <h6 class="fw-bold text-secondary text-uppercase mb-1" style="font-size: 0.9rem;">
                                        [[ getNivelLabel(nivelNum) ]]
                                    </h6>
                                    
                                    <div class="table-responsive">
                                        <table class="table table-sm table-borderless table-print mb-1">
                                            <tbody>
                                                <tr v-for="(info, horarioKey) in horarios" :key="horarioKey">
                                                    <td class="ps-3 py-0">
                                                        <span class="fw-bold text-dark" style="font-size: 0.85rem;">‚Ä¢ [[ info.texto ]]</span>
                                                    </td>
                                                    <td class="text-end pe-3 py-0" style="width: 150px;">
                                                        <span class="badge bg-white text-dark border border-secondary rounded-pill" style="font-size: 0.75rem;">
                                                            # Paralelos: [[ info.cantidad ]]
                                                        </span>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="completos" role="tabpanel">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3 no-print">
                        <h5 class="card-title fw-bold">Listado Completo de Horarios</h5>
                        <button class="btn btn-outline-primary btn-sm" @click="imprimirCompletos">üñ®Ô∏è Imprimir Lista</button>
                    </div>

                    <div v-if="!loading">
                        <div v-for="(niveles, idioma) in reporteCompletoData" :key="idioma" class="mb-5 section-break-always">
                            <div class="text-center mb-4 pb-2 border-bottom title-keep">
                                <h2 class="fw-bold text-uppercase text-dark">[[ idioma ]]</h2>
                            </div>

                            <div v-for="(eventosNivel, nivel) in niveles" :key="nivel" class="mb-4 avoid-break">
                                <h5 class="fw-bold text-white bg-secondary p-2 ps-3 rounded-top mb-0" style="font-size: 1rem;">
                                    [[ getNivelLabel(nivel) ]]
                                </h5>

                                <div class="table-responsive">
                                    <table class="table table-bordered table-striped table-hover text-center align-middle mb-0 table-list-print">
                                        <thead class="bg-light text-dark">
                                            <tr>
                                                <th style="width: 15%;">MODALIDAD</th>
                                                <th style="width: 10%;">PARALELO</th>
                                                <th style="width: 40%;">HORARIO</th>
                                                <th style="width: 35%;">PROFESOR</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr v-for="clase in ordenarClases(eventosNivel)" :key="clase.id">
                                                <td class="fw-bold" :class="clase.modalidad === 'ONLINE' ? 'text-warning-dark' : 'text-primary'">
                                                    [[ clase.modalidad ]]
                                                </td>
                                                <td class="fw-bold fs-5">[[ clase.curso ]]</td>
                                                <td class="text-start ps-4">[[ getHorarioTexto(clase.start, clase.end, clase.rawModalidad) ]]</td>
                                                <td class="text-start ps-4">[[ clase.profesor ]]</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="stats" role="tabpanel">
            <div class="container-fluid p-0">
                <div v-if="estadisticas.resumen" class="row mb-4">
                    <div class="col-md-3">
                        <div class="card text-white bg-primary mb-3 h-100 shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title">üë®‚Äçüè´ Profesores</h5>
                                <h2 class="display-4 fw-bold">[[ estadisticas.resumen.total_profesores ]]</h2>
                                <p class="card-text small opacity-75">Activos en n√≥mina</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-white bg-success mb-3 h-100 shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title">üìö Cursos Totales</h5>
                                <h2 class="display-4 fw-bold">[[ estadisticas.resumen.total_cursos ]]</h2>
                                <p class="card-text small opacity-75">Paralelos planificados</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-white bg-info mb-3 h-100 shadow-sm">
                            <div class="card-body text-white">
                                <h5 class="card-title">üìñ Materias</h5>
                                <h2 class="display-4 fw-bold">[[ estadisticas.resumen.total_materias ]]</h2>
                                <p class="card-text small opacity-75">Idiomas ofertados</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-white bg-secondary mb-3 h-100 shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title">‚ö° Ocupaci√≥n</h5>
                                <h2 class="display-4 fw-bold">[[ estadisticas.resumen.ocupacion_global_pct ]]%</h2>
                                <p class="card-text small opacity-75">Capacidad docente utilizada</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="estadisticas.resumen" class="row mb-4">
                    <div class="col-md-6">
                        <div class="card shadow-sm h-100">
                            <div class="card-header bg-light fw-bold">Distribuci√≥n por Modalidad</div>
                            <div class="card-body">
                                <div v-for="(count, mod) in estadisticas.resumen.distribucion_modalidad" :key="mod" class="mb-3">
                                    <div class="d-flex justify-content-between mb-1">
                                        <span class="small fw-bold">[[ mod ]]</span>
                                        <span class="small badge bg-dark">[[ count ]] cursos</span>
                                    </div>
                                    <div class="progress" style="height: 10px;">
                                        <div class="progress-bar bg-warning" role="progressbar" 
                                             :style="{ width: (count / estadisticas.resumen.total_cursos * 100) + '%' }"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card shadow-sm h-100">
                            <div class="card-header bg-light fw-bold">Distribuci√≥n por Cursos</div>
                            <div class="card-body p-0">
                                <ul class="list-group list-group-flush">
                                    <li v-for="(item, index) in estadisticas.resumen.top_materias" :key="index" 
                                        class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>[[ index + 1 ]]. [[ item[0] ]]</span>
                                        <span class="badge bg-primary rounded-pill">[[ item[1] ]] paralelos</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-12 mb-4">
                    <div class="card shadow-sm">
                        <div class="card-header bg-light fw-bold">Detalle de Carga Horaria Docente</div>
                        <div class="card-body">
                            <div v-for="p in estadisticas.profesores" :key="p.id" class="mb-3">
                                <div class="d-flex justify-content-between mb-1">
                                    <span class="fw-bold">[[ p.nombre ]]</span>
                                    <span :class="getEstadoClass(p.estado)">
                                        [[ p.horas_asignadas ]] / [[ p.horas_maximas ]] hrs ([[ p.estado ]])
                                    </span>
                                </div>
                                <div class="progress">
                                    <div class="progress-bar" role="progressbar" 
                                         :style="{ width: p.porcentaje + '%', backgroundColor: getColorBarra(p.estado) }">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="individual" role="tabpanel">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <div class="row no-print mb-3 bg-light p-3 rounded mx-0">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Seleccionar Profesor:</label>
                            <select v-model="profesorSeleccionado" class="form-select shadow-sm">
                                <option :value="null">-- Seleccione --</option>
                                <option v-for="p in profesores_list" :value="p.id">[[ p.nombre ]]</option>
                            </select>
                        </div>
                        <div class="col-md-6 d-flex align-items-end">
                            <button class="btn btn-primary w-100 shadow-sm" @click="imprimirIndividual" :disabled="!profesorSeleccionado || !tieneClases">
                                üñ®Ô∏è Descargar PDF Individual
                            </button>
                        </div>
                    </div>

                    <div v-if="profesorSeleccionado && tieneClases" id="print-area-individual">
                        <div class="text-center mb-2">
                            <h6 class="text-uppercase text-muted ls-2 mb-1">Horario Individual de Clases</h6>
                            <h3 class="fw-bold text-uppercase">[[ getNombreProfesor(profesorSeleccionado) ]]</h3>
                            <hr class="w-25 mx-auto my-2">
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-bordered text-center align-middle table-individual-print">
                                <thead class="bg-primary text-white">
                                    <tr>
                                        <th style="width: 10%;">HORA</th>
                                        <th style="width: 20%;">LUNES</th>
                                        <th style="width: 20%;">MARTES</th>
                                        <th style="width: 20%;">MI√âRCOLES</th>
                                        <th style="width: 20%;">JUEVES</th>
                                        <th style="width: 10%;" class="bg-secondary">S√ÅB / DOM</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="hora in [7,8,9,10,11,12,13,14,15,16,17,18,19,20,21]" :key="hora">
                                        <td class="fw-bold bg-light">[[ hora ]]:00 - [[ hora + 1 ]]:00</td>
                                        
                                        <td v-for="dia in [0,1,2,3]" :key="dia">
                                            <div v-if="getClaseEnHora(dia, hora)">
                                                <div class="clase-box presencial">
                                                    <strong>[[ getClaseEnHora(dia, hora).materia ]]</strong><br>
                                                    <span class="small">[[ getClaseEnHora(dia, hora).curso ]]</span><br>
                                                    <span class="badge-mod">[[ getClaseEnHora(dia, hora).modalidad ]]</span>
                                                </div>
                                            </div>
                                        </td>
                                        
                                        <td class="bg-light">
                                            <div v-if="getClaseEnHora(5, hora)" class="mb-1">
                                                <div class="clase-box online">
                                                    <span class="badge bg-dark fw-normal" style="font-size: 0.5rem;">S√ÅB</span> 
                                                    <strong>[[ getClaseEnHora(5, hora).materia ]]</strong>
                                                    <span class="small">([[ getClaseEnHora(5, hora).curso ]])</span>
                                                </div>
                                            </div>
                                            <div v-if="getClaseEnHora(6, hora)">
                                                <div class="clase-box online">
                                                    <span class="badge bg-dark fw-normal" style="font-size: 0.5rem;">DOM</span>
                                                    <strong>[[ getClaseEnHora(6, hora).materia ]]</strong>
                                                    <span class="small">([[ getClaseEnHora(6, hora).curso ]])</span>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div v-else-if="profesorSeleccionado && !tieneClases" class="alert alert-info mt-5 text-center p-5 no-print">
                        <h4>‚ÑπÔ∏è Sin Asignaciones</h4>
                        <p>El profesor seleccionado no tiene clases asignadas.</p>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<style>
    /* Estilos Generales */
    .ls-2 { letter-spacing: 2px; }
    .text-warning-dark { color: #856404 !important; }
    
    .clase-box {
        padding: 4px;
        border-radius: 4px;
        font-size: 0.85rem;
        margin-bottom: 2px;
    }
    .clase-box.presencial { background-color: #e3f2fd; color: #0d6efd; border-left: 3px solid #0d6efd; }
    .clase-box.online { background-color: #fff3cd; color: #856404; border-left: 3px solid #ffc107; }
    .badge-mod { font-size: 0.65rem; text-transform: uppercase; opacity: 0.8; }

    /* ESTILOS DE IMPRESI√ìN */
    .print-header { display: none; }

    @media print {
        @page { margin: 0.5cm; size: A4; margin-top: 0.5cm; }
        
        body { 
            background: white; 
            -webkit-print-color-adjust: exact !important; 
            print-color-adjust: exact !important;
            margin: 0 !important;
            padding: 0 !important;
        }
        
        .no-print, .nav, .btn, .sidebar, header, .sidebar-wrapper, .navbar, footer { display: none !important; }
        .print-header { display: block !important; margin-bottom: 10px; margin-top: 0; padding-top: 0; }
        .print-header.d-none { display: none !important; }

        .card { border: none !important; box-shadow: none !important; }
        
        /* Reporte General */
        .section-break { page-break-inside: auto; margin-bottom: 15px; display: block; }
        .title-keep, h3 { page-break-after: avoid; break-after: avoid; }
        .avoid-break { page-break-inside: avoid; }
        
        .modal-header-print { background-color: #f8f9fa !important; border-left: 5px solid #000 !important; color: black !important; padding: 2px !important; page-break-after: avoid; }
        .table-print td { border-bottom: 1px solid #eee; padding: 2px 0; font-size: 0.8rem; }
        
        /* Reporte Completo */
        .section-break-always { page-break-before: always; }
        .table-list-print th { background-color: #333 !important; color: white !important; font-size: 0.8rem !important; padding: 4px; }
        .table-list-print td { font-size: 0.8rem !important; padding: 4px !important; border-bottom: 1px solid #ccc !important; }
        
        /* Individual */
        .table-individual-print th { background-color: #0d6efd !important; color: white !important; font-size: 0.65rem !important; padding: 2px !important; }
        .table-individual-print td { font-size: 0.65rem !important; padding: 1px !important; height: 25px; }
        .clase-box { border: 1px solid #ccc; background: none !important; color: black !important; font-size: 0.6rem !important; padding: 1px; }
        
        .tab-pane { display: block !important; opacity: 1 !important; visibility: visible !important; }
        .tab-pane:not(.active) { display: none !important; }
    }
</style>

<script>
    const { createApp } = Vue

    createApp({
        compilerOptions: { delimiters: ['[[', ']]'] },
        data() {
            return {
                loading: true,
                estadisticas: { profesores: [], resumen: {} }, // Inicializar resumen vac√≠o
                profesores_list: [],
                materias_list: [],
                allEvents: [],
                profesorSeleccionado: null,
                tieneClases: false,
                reporteGeneralData: {},
                reporteCompletoData: {}, 
                isPrintingIndividual: false,
                isPrintingCompletos: false 
            }
        },
        mounted() {
            this.cargarDatos();
        },
        watch: {
            profesorSeleccionado(newVal) {
                if (!newVal) {
                    this.tieneClases = false;
                    return;
                }
                const tiene = this.allEvents.some(e => e.extendedProps.profesor_id === newVal);
                this.tieneClases = tiene;
            }
        },
        methods: {
            async cargarDatos() {
                this.loading = true;
                try {
                    const [resStats, resProfes, resMaterias, resHorario] = await Promise.all([
                        fetch('/api/estadisticas'),
                        fetch('/api/profesores'),
                        fetch('/api/materias'),
                        fetch('/api/horario')
                    ]);
                    
                    this.estadisticas = await resStats.json();
                    this.profesores_list = await resProfes.json();
                    this.materias_list = await resMaterias.json();
                    this.allEvents = await resHorario.json();
                    
                    this.procesarReporteGeneral();
                    this.procesarReporteCompleto();

                } catch (e) { console.error(e); }
                finally { this.loading = false; }
            },

            // --- L√≥gica Reporte Resumido ---
            procesarReporteGeneral() {
                const agrupado = {};
                this.allEvents.forEach(ev => {
                    const props = ev.extendedProps;
                    const matObj = this.materias_list.find(m => m.id === props.materia_id);
                    const nombreMateria = matObj ? matObj.nombre : "Desconocido";
                    const nivel = matObj ? matObj.nivel : 0;
                    let modTexto = props.modalidad.includes('ONLINE') ? "EN L√çNEA" : "PRESENCIAL";
                    
                    const fecha = new Date(ev.start);
                    const diaSemana = fecha.getDay(); 
                    const horaInicio = fecha.getHours();
                    const horaFin = new Date(ev.end).getHours();
                    const hIniStr = horaInicio.toString().padStart(2, '0') + ":00";
                    const hFinStr = horaFin.toString().padStart(2, '0') + ":00";
                    
                    let textoHorario = "";
                    let ordenDia = 0;

                    if (diaSemana >= 1 && diaSemana <= 4) { 
                        textoHorario = `lunes a jueves ${hIniStr} - ${hFinStr}`;
                        ordenDia = 1;
                    } else if (diaSemana === 6) { 
                        textoHorario = `s√°bado ${hIniStr} a ${hFinStr}`;
                        ordenDia = 3;
                    } else if (diaSemana === 0) { 
                        textoHorario = `domingo ${hIniStr} a ${hFinStr}`;
                        ordenDia = 4;
                    }

                    if (!agrupado[nombreMateria]) agrupado[nombreMateria] = {};
                    if (!agrupado[nombreMateria][modTexto]) agrupado[nombreMateria][modTexto] = {};
                    if (!agrupado[nombreMateria][modTexto][nivel]) agrupado[nombreMateria][modTexto][nivel] = {};
                    
                    const keyHorario = `${ordenDia}_${textoHorario}`;
                    if (!agrupado[nombreMateria][modTexto][nivel][keyHorario]) {
                        agrupado[nombreMateria][modTexto][nivel][keyHorario] = new Set();
                    }
                    const match = ev.title.match(/\(([^)]+)\)/);
                    agrupado[nombreMateria][modTexto][nivel][keyHorario].add(match ? match[1] : "UNK");
                });

                const resultadoFinal = {};
                Object.keys(agrupado).sort().forEach(idioma => {
                    resultadoFinal[idioma] = {};
                    Object.keys(agrupado[idioma]).sort().forEach(mod => {
                        resultadoFinal[idioma][mod] = {};
                        Object.keys(agrupado[idioma][mod]).sort((a,b) => a-b).forEach(nivel => {
                            const horariosObj = agrupado[idioma][mod][nivel];
                            const listaHorarios = [];
                            Object.keys(horariosObj).sort().forEach(key => {
                                listaHorarios.push({ texto: key.split('_')[1], cantidad: horariosObj[key].size });
                            });
                            resultadoFinal[idioma][mod][nivel] = listaHorarios;
                        });
                    });
                });
                this.reporteGeneralData = resultadoFinal;
            },

            // --- L√≥gica Reporte Completo ---
            procesarReporteCompleto() {
                const datos = {};
                const cursosProcesados = new Set();

                this.allEvents.forEach(ev => {
                    const props = ev.extendedProps;
                    const matObj = this.materias_list.find(m => m.id === props.materia_id);
                    const idioma = matObj ? matObj.nombre : "OTRO";
                    const nivel = matObj ? matObj.nivel : 0;
                    
                    const match = ev.title.match(/\(([^)]+)\)/);
                    const letraCurso = match ? match[1] : props.curso_turno;
                    
                    const uniqueKey = `${props.materia_id}-${letraCurso}-${props.modalidad}`;

                    if (cursosProcesados.has(uniqueKey)) return;
                    cursosProcesados.add(uniqueKey);

                    if (!datos[idioma]) datos[idioma] = {};
                    if (!datos[idioma][nivel]) datos[idioma][nivel] = [];
                    
                    const lines = ev.title.split('\n');
                    
                    datos[idioma][nivel].push({
                        id: Math.random(),
                        profesor: lines[1],
                        curso: letraCurso, 
                        modalidad: props.modalidad.includes('ONLINE') ? 'ONLINE' : 'PRESENCIAL',
                        rawModalidad: props.modalidad, 
                        start: new Date(ev.start),
                        end: new Date(ev.end)
                    });
                });
                this.reporteCompletoData = datos;
            },

            // --- Helpers Generales ---
            getHorarioTexto(start, end, rawMod) {
                if (rawMod && rawMod.includes('FDS')) {
                    const hIni = start.getHours().toString().padStart(2, '0') + ":00";
                    const hFin = end.getHours().toString().padStart(2, '0') + ":00";
                    return `S√°bados y Domingos ${hIni} - ${hFin}`;
                }

                const dia = start.getDay(); 
                const hIni = start.getHours().toString().padStart(2, '0') + ":00";
                const hFin = end.getHours().toString().padStart(2, '0') + ":00";
                
                if (dia >= 1 && dia <= 4) return `Lunes a Jueves ${hIni} - ${hFin}`;
                if (dia === 5) return `Viernes ${hIni} - ${hFin}`;
                if (dia === 6) return `S√°bado ${hIni} - ${hFin}`;
                if (dia === 0) return `Domingo ${hIni} - ${hFin}`;
                return "Horario Especial";
            },

            ordenarClases(eventos) {
                return eventos.sort((a,b) => {
                    if (a.modalidad !== b.modalidad) return b.modalidad.localeCompare(a.modalidad);
                    return a.curso.localeCompare(b.curso);
                });
            },

            getNivelLabel(nivel) {
                const n = parseInt(nivel);
                if (n === 1) return "Nivel 1: A1 ‚Äì Principiante";
                if (n === 2) return "Nivel 2: A2 ‚Äì Elemental";
                if (n === 3) return "Nivel 3: B1 ‚Äì Pre-intermedio";
                if (n === 4) return "Nivel 4: B1+ ‚Äì Intermedio";
                if (n === 5) return "Nivel 5: B2 ‚Äì Intermedio Alto";
                if (n >= 6) return `Nivel ${n}: Avanzado`;
                return `Nivel ${n}`;
            },
            getNombreProfesor(id) {
                const p = this.profesores_list.find(x => x.id === id);
                return p ? p.nombre : '';
            },
            getEstadoClass(estado) {
                if(estado === 'SIN_CARGA') return 'text-danger';
                if(estado === 'SOBRECARGA') return 'text-warning';
                return 'text-success';
            },
            getColorBarra(estado) {
                if(estado === 'SIN_CARGA') return '#dc3545';
                if(estado === 'SOBRECARGA') return '#ffc107';
                return '#198754';
            },

            imprimirGeneral() {
                this.isPrintingIndividual = false;
                this.isPrintingCompletos = false;
                const originalTitle = document.title;
                document.title = "Reporte_General_Oferta";
                setTimeout(() => { window.print(); document.title = originalTitle; }, 100);
            },
            imprimirCompletos() {
                this.isPrintingIndividual = false;
                this.isPrintingCompletos = true; 
                const originalTitle = document.title;
                document.title = "Horarios_Completos_Lista";
                this.$nextTick(() => {
                    window.print();
                    document.title = originalTitle;
                    this.isPrintingCompletos = false; 
                });
            },
            imprimirIndividual() {
                this.isPrintingIndividual = true;
                this.isPrintingCompletos = false;
                const nombre = this.getNombreProfesor(this.profesorSeleccionado);
                const nombreSafe = nombre.replace(/[^a-zA-Z0-9]/g, '_');
                const originalTitle = document.title;
                document.title = `Horario_${nombreSafe}`;
                this.$nextTick(() => {
                    window.print();
                    document.title = originalTitle;
                    this.isPrintingIndividual = false;
                });
            },

            getClaseEnHora(diaTarget, horaTarget) {
                if (!this.profesorSeleccionado) return null;
                const eventosProfe = this.allEvents.filter(e => e.extendedProps.profesor_id === this.profesorSeleccionado);
                const clase = eventosProfe.find(ev => {
                    const d = new Date(ev.start);
                    let jsDay = d.getDay(); 
                    let dbDay = jsDay === 0 ? 6 : jsDay - 1; 
                    if (dbDay !== diaTarget) return false;
                    const hStart = d.getHours();
                    const hEnd = new Date(ev.end).getHours();
                    return horaTarget >= hStart && horaTarget < hEnd; 
                });
                if (!clase) return null;
                const lines = clase.title.split('\n');
                return {
                    materia: lines[0],
                    profesor: lines[1],
                    curso: clase.extendedProps.curso_turno,
                    modalidad: clase.extendedProps.modalidad.includes('ONLINE') ? 'ONLINE' : 'PRESENCIAL'
                };
            }
        }
    }).mount('#app-reportes')
</script>
{% endblock %}